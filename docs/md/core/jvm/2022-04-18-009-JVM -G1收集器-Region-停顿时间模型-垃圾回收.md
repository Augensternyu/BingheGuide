---
layout: post
category: binghe-code-jvm
title: G1收集器、Region、停顿时间模型、垃圾回收
tagline: by 冰河
tag: [jvm,binghe-code-jvm]
excerpt: 今天，我们继续学习JVM相关的知识，今天给大家分享一篇关于G1收集器的文章，好了，不多说了，直接进入正题。
lock: need
---

# JVM - G1收集器、Region、停顿时间模型、垃圾回收

**大家好，我是冰河~~**

今天，我们继续学习JVM相关的知识，今天给大家分享一篇关于G1收集器的文章，好了，不多说了，直接进入正题。

## Region

使用G1收集器时，java堆的内存会划分为多个大小相等的独立区域（Region），他也有新生代和老年代的概念，但是新生代和老年代不再是物理隔离的，它们都是一部分Region（不需要连续）的集合.

如下图所示：粉色的代表新生代，没有字母的是eden，有s的是survivor ，老年代是浅蓝的O，还有一个H是humongous，也是老年代，我们在《[JVM堆内存分配机制（建议收藏）](https://mp.weixin.qq.com/s?__biz=Mzg4MjU0OTM1OA==&mid=2247499346&idx=1&sn=fd0b892c55177cc78cc69be0ff7e84c1&chksm=cf564953f821c0454f31bd284748b26ae2aec1795cbf62625fddc64fae99c4687795de3d066e&token=1592218080&lang=zh_CN#rd)》提过，大对象直接进入老年代，这个humongous就是存储大对象的，也就是说如果对象内存大小大于Region的一半大小，那就会给一个专门的Region存放，如果对象大于一个Region的大小，那就用多个Region存放。

![](https://segmentfault.com/img/bVcLtbX)

我们只画了16个Region，并不是说堆只分配了16个，在没有用-XX:G1HeapRegionSize去指定的情况下，默认是2048个，Region的个数必须是2的倍数，每个Region的大小在1到32M之间。

新生代的大小在5%到60%之间，可以通过`-XX:G1NewSizePercent=5`，`-XX:G1MaxNewSizePercent=60`来设置。

## 停顿时间模型

G1的另外一个特点，就是建立可预测的停顿时间模型。G1跟踪各个Region的回收价值，并在后台维护一个优先列表，每次根据允许的收集时间，优先回收价值最大的Region，保证了在有限的时间内获取尽可能高的收集效率，停顿时间默认200ms，用`-XX:MaxGCPauseMillis`设置。

比如下图，第一个新生代的Region回收10M需要5ms，第二个新生代的Region回收20M也只要5ms，第三个新生代的Region回收10M却需要10ms，如果指定他需要5ms内回收20M的垃圾，他会直接去回收第二个新生代的Region，而不是回收第一个和第三个新生代的Region。

![](https://segmentfault.com/img/bVcLs86)

## 垃圾回收

### 新生代回收

上面提过，新生代的内存空间最多占用60%，当60%的空间用完的时候，就会触发新生代的回收。新生代的回收是用复制算法的，与之前不同的是，他会考虑到停顿时间。

### 老年代回收

老年代回收分为：**初始标记、并发标记、最终标记、混合回收**。

前面三个阶段跟《[JVM - CMS垃圾收集器（建议收藏）](https://mp.weixin.qq.com/s?__biz=Mzg4MjU0OTM1OA==&mid=2247499410&idx=1&sn=787037527afd5762e407626d010a7589&chksm=cf564993f821c085f481e96730ab0c0ff59db0dfa6630e72e3fcfd5ef2656e5f3bfd2b56253e&token=1592218080&lang=zh_CN#rd)》的前面三个类似。

混合回收，是说他并不会仅仅回收老年代的垃圾，也会回收新生代的垃圾，他会根据停顿时间，尽可能的多回收Region。由于在停顿时间内回收的垃圾可能不会很多，所以这个阶段会进行多次的混合回收，默认是8次，可以通过`-XX:G1MixedGCCountTarget`设置。
如果混合回收的时候，发现Region仅占有5%了，那他就会停止回收，不会一直回收8次。

混合回收的基于复制算法的，所以大对象的复制会比较耗时，如果某个老年代的Region超过85%的对象是存活的，那他不会被回收，通过`-XX:G1MixedGCLiveThresholdPercent`设置。

**好了，今天就到这儿吧，我是冰河，我们下期见~~**

## 写在最后

> 如果你觉得冰河写的还不错，请微信搜索并关注「 **冰河技术** 」微信公众号，跟冰河学习高并发、分布式、微服务、大数据、互联网和云原生技术，「 **冰河技术** 」微信公众号更新了大量技术专题，每一篇技术文章干货满满！不少读者已经通过阅读「 **冰河技术** 」微信公众号文章，吊打面试官，成功跳槽到大厂；也有不少读者实现了技术上的飞跃，成为公司的技术骨干！如果你也想像他们一样提升自己的能力，实现技术能力的飞跃，进大厂，升职加薪，那就关注「 **冰河技术** 」微信公众号吧，每天更新超硬核技术干货，让你对如何提升技术能力不再迷茫！


![](https://img-blog.csdnimg.cn/20200906013715889.png)